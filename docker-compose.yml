version: '3.8'

services:
  ubuntu-automation:
    image: ghcr.io/workerspages/ubuntu-automation:latest
    container_name: ubuntu-automation
    hostname: automation-server
    
    ports:
      - "5000:5000"
      - "5901:5901"
      - "6901:6901"
    
    environment:
      # ============ VNC配置 ============
      - VNC_PW=YourStrongPassword123!          # 修改为你的VNC密码
      - VNC_RESOLUTION=1920x1080               # 桌面分辨率
      - VNC_COL_DEPTH=24                       # 颜色深度
      
      # ============ Web应用配置 ============
      - SECRET_KEY=your-super-secret-key-min-32-chars-long-random-string-here
      - FLASK_ENV=production
      - FLASK_DEBUG=false
      - HOST=0.0.0.0
      - PORT=5000
      
      # ============ Telegram通知配置 ============
      # 从 @BotFather 获取Bot Token
      - TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz123456789
      # 从 @userinfobot 获取Chat ID（个人聊天或群组ID）
      - TELEGRAM_CHAT_ID=-1001234567890
      
      # ============ 时区和语言配置 ============
      - TZ=Asia/Shanghai
      - LANG=zh_CN.UTF-8
      - LANGUAGE=zh_CN:zh
      - LC_ALL=zh_CN.UTF-8
      
      # ============ 数据库配置 ============
      - DATABASE_URL=sqlite:////app/data/tasks.db
      - SQLALCHEMY_DATABASE_URI=sqlite:////app/data/tasks.db
      - SQLALCHEMY_TRACK_MODIFICATIONS=false
      
      # ============ 调度器配置 ============
      - SCHEDULER_TIMEZONE=Asia/Shanghai
      - SCHEDULER_API_ENABLED=true
      
      # ============ Selenium配置 ============
      - SCRIPTS_DIR=/home/headless/Downloads
      - MAX_SCRIPT_TIMEOUT=300
      - RETRY_FAILED_TASKS=true
      - MAX_RETRIES=3
      
      # ============ 日志配置 ============
      - LOG_LEVEL=INFO
      - LOG_FILE=/app/data/automation.log
      
      # ============ Firefox配置 ============
      - FIREFOX_BINARY=/usr/bin/firefox
      - GECKODRIVER_PATH=/usr/bin/geckodriver
      
    volumes:
      - ./data:/app/data
      - ./scripts:/home/headless/Downloads
      - ./logs:/app/logs
      - ./firefox-profile:/home/headless/.mozilla
      - ./firefox-xpi:/app/firefox-xpi:ro
    
    restart: unless-stopped
    
    # 建议添加以下配置：
    
    # 共享内存大小（Selenium和Chrome需要）
    shm_size: '2gb'
    
    # 资源限制（防止容器占用过多资源）
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    
    # 健康检查
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # 网络配置
    networks:
      - automation-net

networks:
  automation-net:
    driver: bridge

# /etc/supervisor/conf.d/supervisord.conf

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
loglevel=info

# 修复：为 VNC 和 XFCE 创建 Xauthority 凭证
# 在 vnc 服务启动前，先生成一个凭证文件
[eventlistener:xauth_generator]
command=bash -c "touch /home/headless/.Xauthority && xauth generate :1 . trusted"
autostart=true
user=headless
events=PROCESS_STATE_RUNNING
stdout_logfile=/var/log/supervisor/xauth-stdout.log
stderr_logfile=/var/log/supervisor/xauth-stderr.log

[program:vnc]
command=/usr/bin/Xvnc :1 -desktop "Ubuntu自动化平台" -geometry 1360x768 -depth 24 -rfbport 5901 -rfbauth /home/headless/.vncpasswd -auth /home/headless/.Xauthority -SecurityTypes VncAuth -AlwaysShared -AcceptKeyEvents -AcceptPointerEvents -AcceptCutText -SendCutText -localhost no
user=headless
autostart=true
autorestart=true
priority=100
stdout_logfile=/var/log/supervisor/vnc-stdout.log
stderr_logfile=/var/log/supervisor/vnc-stderr.log
environment=HOME="/home/headless",USER="headless",DISPLAY=":1"

[program:xfce]
command=startxfce4
user=headless
autostart=true
autorestart=true
priority=200
stdout_logfile=/var/log/supervisor/xfce-stdout.log
stderr_logfile=/var/log/supervisor/xfce-stderr.log
# 修复：确保 xfce 进程能找到凭证
environment=HOME="/home/headless",USER="headless",DISPLAY=":1",XAUTHORITY="/home/headless/.Xauthority"

[program:novnc]
command=/usr/bin/websockify --web=/usr/share/novnc 6901 localhost:5901
user=headless
autostart=true
autorestart=true
priority=300
stdout_logfile=/var/log/supervisor/novnc-stdout.log
stderr_logfile=/var/log/supervisor/novnc-stderr.log

[program:webapp]
# 修复：在启动 Flask 应用前，先修复 /app/data 目录的权限
command=bash -c "chown -R headless:headless /app/data && exec /opt/venv/bin/python3 /app/web-app/app.py"
directory=/app/web-app
user=headless
autostart=true
autorestart=true
priority=300
stdout_logfile=/var/log/supervisor/webapp-stdout.log
stderr_logfile=/var/log/supervisor/webapp-stderr.log
environment=HOME="/home/headless",USER="headless"

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
user=root
autostart=true
autorestart=true
priority=400
stdout_logfile=/var/log/supervisor/nginx-stdout.log
stderr_logfile=/var/log/supervisor/nginx-stderr.log
